image: registry.gitlab.com/attu/cxx

stages:
- build
- test
- post

.template: &gcc
  variables:
    CXX: g++

.template: &clang
  variables:
    CXXFLAGS: -stdlib=libc++
    CXX: clang++
    LINKFLAGS: -stdlib=libc++

.template: &debug
  stage: build
  before_script:
  - source ./config/debug.sh

.template: &release
  stage: build
  before_script:
  - source ./config/release.sh

.template: &sanitize
  stage: test
  before_script:
  - source ./config/sanitize.sh

.template: &benchmark
  stage: test
  before_script:
  - source ./config/release.sh
  after_script:
  - ./waf benchmark

.template: &coverage
  stage: post
  before_script:
  - source ./config/coverage.sh
  after_script:
  - >-
     gcovr
     --branch
     --root=build
     --filter='.*cxx.*'
     --filter='.*src.*'
     --print-summary

.template: &build
  script:
  - ./waf configure --prefix=usr build install --destdir=/

gcc:debug:
  <<: *gcc
  <<: *debug
  <<: *build

gcc:release:
  <<: *gcc
  <<: *release
  <<: *build

clang:debug:
  <<: *clang
  <<: *debug
  <<: *build

clang:release:
  <<: *clang
  <<: *release
  <<: *build

gcc:sanitize:
  <<: *gcc
  <<: *sanitize
  <<: *build

clang:sanitize:
  <<: *clang
  <<: *sanitize
  <<: *build

gcc:benchmark:
  <<: *gcc
  <<: *benchmark
  <<: *build

gcc:coverage:
  <<: *gcc
  <<: *coverage
  <<: *build
